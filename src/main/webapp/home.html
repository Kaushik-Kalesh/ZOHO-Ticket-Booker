<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cinema Shows</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="navbar-container"></div>

<h1>Available Shows</h1>

<div id="app"></div>

<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<script src="helpers.js"></script>

<!-- Templates -->
<script id="appTpl" type="text/x-handlebars-template">
    {{#each groupedShows}}
    <h2>{{formatDate date}}</h2>
    <hr/>

    <table>
        <thead>
            <tr>
                <th>Title</th>
                <th>Time</th>
                <th>Screen</th>
                <th>Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {{#each shows}}
            <tr>
                <td>{{title}}</td>
                <td>{{timeDisplay startTime}}</td>
                <td>{{screen.name}}</td>
                <td>Rs. {{screen.price}}</td>
                <td>
                    <button data-open="bookShowModal"
                            data-show-id="{{id}}"
                            data-screen-id="{{screen.id}}">Book</button>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>

    <br/>
    {{/each}}
</script>
<!-- End Templates -->

<!-- Modals -->
<div id="bookShowModal" class="modal">
    <div class="modal-box">
        <h3>Book Seats</h3>
        <form id="bookShowForm">
            <input type="number" name="seatQty" placeholder="Seats Qty" required><br><br>
            <button type="submit">Submit</button>
        </form>
        <p id="bookingErrorMsg" style="font-weight: bold; color: red"></p>
    </div>
</div>
<!-- End Modals -->

<script src="navbar.js"></script>

<script>
    let selectedShowId = null;
    let selectedScreenId = null;

    const load = async () => {
        try {
            const title = new URLSearchParams(window.location.search).get("title") || "";
            const res = await fetch(`/TicketBooker-0.1/home?title=${encodeURIComponent(title)}`);
            const data = await res.json();

            if (data.error) {
                window.location.href = '/TicketBooker-0.1';
                return;
            }

            const grouped = groupShowsByDate(data.shows);

            const source = document.getElementById("appTpl").innerHTML;
            const template = Handlebars.compile(source);

            document.getElementById("app").innerHTML =
                template({ groupedShows: grouped });

        } catch (err) {
            console.error("Failed to load shows:", err);
        }
    }

    const groupShowsByDate = (shows) => {
        const map = {};

        shows.forEach(show => {
            const dateKey = show.startTime.split("T")[0];

            if (!map[dateKey]) {
                map[dateKey] = [];
            }

            map[dateKey].push(show);
        });

        return Object.keys(map)
            .sort((a, b) => new Date(a) - new Date(b))
            .map(date => ({
                date,
                shows: map[date].sort((a, b) =>
                    new Date(a.startTime) - new Date(b.startTime)
                )
            }));
    }

    load();

    document.getElementById("app").addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-open='bookShowModal']");
            if (!btn) return;

            selectedShowId = btn.dataset.showId;
            selectedScreenId = btn.dataset.screenId;
    });


    document.getElementById("bookShowForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = e.target;
        const payload = {
            showId: Number(selectedShowId),
            screenId: Number(selectedScreenId),
            seatQty: formData.seatQty.valueAsNumber
        };
        const res = await fetch('/TicketBooker-0.1/book', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            window.location.reload();
        } else {
            const errorData = await res.json();
            document.getElementById("bookingErrorMsg").textContent = errorData.error;
        }
    });
</script>

</body>
</html>
